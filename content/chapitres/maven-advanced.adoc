[{invert}]
= Maven : Niveau 2

== Maven ?

Pourquoi est-ce qu'on s'emb√™te avec des outils comme Maven ?

[.small]
Make c'est bien suffisant non ?

== Do It Ourselves or Reinvent the Wheel ?

*Probl√®me* : Doit-on recoder tous ses outils ou r√©utiliser des choses existantes ?

image::reinvent-wheel.jpg[]

*R√©ponse* : √ßa d√©pends donc ce sera √† vous de juger et de r√©-√©valuer

== D√©pendances Externes

*Hypoth√®se* : on a besoin de code et d'outils externes (e.g. √©crits par quelqu'un d'autre)

* Comment faire si le code externe est mis √† jour ?
* Que se passe t'il si le code externe est supprim√© de l'internet ?
[.small]
** https://github.blog/2020-11-16-standing-up-for-developers-youtube-dl-is-back/[window="_blank"]
* Acceptez-vous d'ex√©cuter le code de quelqu'un d'autre sur votre machine ?
* Et si quelqu'un injecte du code malicieux dans le code externe ?
[.small]
** https://www.zdnet.com/article/malicious-npm-packages-caught-installing-remote-access-trojans/[window="_blank"]

== TOUS les languages...

// The triple plus (`+++`) are used to escape the first dot (and avoid a numbered bullet list)
+++...+++ sont concern√©s

== Pourquoi Maven ?

* On fait du Java...
** Alternatives en Java : Gradle, Bazel, Ant
* Bon exemple d'application car complet (cycle de vie, configuration, d√©pendances)
* Plut√¥t mature (1√®re release : 2004)

== Maven : `pom.xml`

* Maven a besoin d'un fichier `pom.xml` √† la racine de votre projet
* XML : language de type "markup", avec un **sch√©ma**, donc strict
* "POM" signifie "Project Object Model"
* Concept de "Convention au lieu de configuration" pour limiter la complexit√©

[source,xml]
----
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <!-- Contenu du fichier pom.xml -->

</project>
----

== Maven : Identit√© d'un projet

Maven identifie un projet par l‚Ä¢'‚Ä¢es artefact‚Ä¢s g√©n√©r√©‚Ä¢s ,
en utilisant les 3 √©l√©ments *obligatoires* suivants :

* **groupId** : Identifiant unique de votre projet suivant les r√®gles Java de nommage de paquets
* **artifactId** : Nom de l'artefact g√©n√©r√© par votre projet
* **version** : Version de l'artefact, qui **devrait** respected le semantic versionning.
[.small]
** Peut √™tre suffix√© par `-SNAPSHOT` pour indiquer une version non releas√©e.

[source,xml]
----
<groupId>com.mycompany.app</groupId>
<artifactId>my-app</artifactId>
<version>1.0-SNAPSHOT</version>
----

== Exercice : Maven From Scratch

=> C'est √† vous dans link:https://gitpod.io/workspaces/[l'environnement GitPod,window="_blank"]

* Cr√©ez un projet vide pour Maven :
[source,bash]
mkdir -p /workspace/mvn-level2/src/main/java && cd /workspace/mvn-level2

* A partir des 2 slides pr√©c√©dentes, cr√©ez un fichier `pom.xml` avec la balise `project` qui d√©finit les sch√©mas,
contenant 4 autres balises : `modelVersion`, `groupId`, `artifactId` et `version`

* Cr√©ez 1 fichier "Hello.java" dans `src/main/java/` avec le contenu ci-dessous :
+
[source,java]
----
class Hello {
  public static void main(String[] args) {
    System.out.println("Hello ENSG !");
  }
}
----

* Essayez de compilez le projet avec `mvn compile` (SPOILER: ‚ùå)

== D√©finir la plateforme d'ex√©cution

Que s'est il pass√© ?

. => Maven a t√©l√©charg√© plein de d√©pendances depuis https://repo.maven.apache.org[]
. => La compilation a √©chou√© avec 2 erreurs et 1 warning :
** ‚ùå `**Source** option 5 is no longer supported. Use 7 or later`
** ‚ùå `**Target** option 5 is no longer supported. Use 7 or later`
** ‚ö†Ô∏è File encoding has not been set, using platform encoding ANSI_X3.4-1968, i.e. build is platform dependent!

== Maven et D√©pendances Externes

* Maven propose 2 types de d√©pendances externes :

** *Plugin* : c'est un artefact qui sera utilis√© par Maven durant son cycle de vie
*** "Build-time dependency"
** *D√©pendance* (üá¨üáß "dependency") : c'est un artefact qui sera utilis√© par votre application,
_en dehors de Maven_
*** "Run-time dependency"

== Maven et Plugins

Quand on regarde sous le capot, Maven est un framework d'ex√©cution de plugins.

=> Tout est plugin :

- Effacer le dossier `./target` ? Un plugin ! (si si essayez `mvn clean` une premi√®re fois...)
- Compiler du Java ? Un plugin !
- Pas de plugin qui fait ce que vous voulez ? Ecrivez un autre plugin !

== !

C'est bien gentil mais comment corriger l'erreur

‚ùå `**Source** option 5 is no longer supported. Use 7 or later` ?

[%step]
* C'est le `maven-compiler-plugin` qui a √©mis l'erreur
* Que dit la https://maven.apache.org/plugins/maven-compiler-plugin/[documentation du plugin] ?
* Il faut d√©finir la cible d'ex√©cution (e.g. la *production*) du programme

== Maven Properties

* Maven permet de d√©finir des propri√©t√©s (üá¨üáß "properties") "CLEF=VALEUR" pour :
** Configurer les plugins (üòá)
** Factoriser un √©l√©ment r√©p√©t√© (une version, une chaine de texte, etc.)

* Le fichier `pom.xml` supporte donc la balise `<properties></properties>`
pour d√©finir des propri√©t√©s sous la forme `<clef>valeur</clef>` :
** La propri√©t√© peut √™tre utilis√© sous la forme `${clef}`

[source,xml]
----
<properties>
  <spring.version>1.0.0</spring.version>
  <ensg.student.name>Damien</ensg.student.name>
</properties>

<build>
  <name>${ensg.student.name}</name>
</build>
----

== Exercice : D√©finir la plateforme d'ex√©cution

*But* : la commande `mvn compile` doit fonctionner sans erreur, et produire un fichier `Hello.class` dans `./target/**`

. Modifiez le fichier `pom.xml` pour ajouter un bloc `<properties>` et d√©finissez la valeur de la propri√©t√© `project.build.sourceEncoding` √† `UTF-8` (r√©solution du warning).

. Utilisez https://maven.apache.org/plugins/maven-compiler-plugin/examples/set-compiler-source-and-target.html[la documentation du Maven Compile Plugin]
pour r√©soudre les 2 erreurs de compilation
** üïµüèΩ Utilisez la version majeure de `java -version`

== Solution : D√©finir la plateforme d'ex√©cution

[source,xml]
----
<properties>
  <maven.compiler.source>15</maven.compiler.source>
  <maven.compiler.target>15</maven.compiler.target>
  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
</properties>
----

== Ex√©cuter l'Application

üëèüèø Succ√®s !

`mvn compile` a produit le fichier `./target/classes/Hello.class`

Ex√©cutons notre programme avec la commande `java`:

[source,bash]
----
# "-cp" == "classpath" (Chemin vers les classes Java "compil√©es")
java -cp ./target/classes/ Hello
# Argument "Hello" == classe qui contient la m√©thode statique "main"
----

== Maven : D√©p√¥ts d'Artefacts

Maven r√©cup√®re les d√©pendances (et plugins) dans des d√©p√¥ts d'artefacts

(üá¨üáß Artifacts Repositories) qui sont de 3 types :

* *Central* : un d√©p√¥t g√©r√© par la communaut√© - https://repo.maven.apache.org[]
* *Remote* : un d√©p√¥t de votre organisation, similaires √† un remote GitHub, h√©berg√© par vos soins
* *Local* : un dossier sur la machine o√π la commande `mvn` est ex√©cut√©, g√©n√©ralement dans `${HOME}/.m2`

== D√©pendances Maven

Pour sp√©cifier les d√©pendances :

* Il faut utiliser la balise `<dependencies>`,
* ... qui est une collection de d√©pendances (balise `<dependency>` - quelle surprise !),
* .. chaque d√©pendance √©tant d√©fini par un trio `<groupId>`, `<artifactId>` et `<version>` (que de surprises...)

Pour les plugins c'est la m√™me id√©e (`<plugins>` -> `<plugin>` -> `<groupId>`, `<artifactId>`, `<version>`)

== Exemple de D√©pendance : Spring

* Revenons aux exercices √† base de tests : nous avons utilis√© le framework Spring

* *Id√©e* : c'est un framework pour ne pas avoir √† tout r√©-√©crire, ex√©cut√© lorsque l'application est en fonctionnement :
c'est donc une _d√©pendance_ de notre application.

Voil√† ce que √ßa donne dans le fichier `pom.xml` :

[source,xml]
----
<dependencies>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <version>2.3.3.RELEASE</version>
  </dependency>
</dependencies>
----

== Exercice avec les d√©pendances Spring

=> C'est √† vous. Ajoutez le bloc pr√©c√©dent dans votre `pom.xml`

* Ex√©cutez la commande `mvn clean compile`
* Explorez le contenu du dossier `$HOME/.m2` (√©criture √©quivalente √† `~/.m2`)
** En particulier :
+
[source,bash]
ls -l ~/.m2/repository/org/springframework/boot/spring-boot-starter-web/2.3.3.RELEASE
+
et
+
[source,bash]
ls -l ~/.m2/repository/org/apache/maven/plugins/

* Supprimez le dossier `~/.m2/` et relancez la commande `mvn clean compile`

== Solution avec les d√©pendances Spring

* Le d√©p√¥t local `.m2` :
** Agit comme un "cache" local contenant d√©pendances et plugins
** Respecte la structure des groupid, artifactId et version

* Commande `mvn install` :
** Ex√©cute les √©tapes `package` et `verify`
** Puis copie le r√©sultat de package dans le dossier `.m2`
** Essayez `mvn install` puis v√©rifiez le contenu de `~/.m2/repository/<groupId en format dossiers>/<artifactId>/<version>`

[source,bash]
ls -l ~/.m2/repository/com/mycompany/app/my-app/1.0-SNAPSHOT/

== Convention Over Configuration

* Maven fonctionne √† base de "convention": lorsque nous avons corrig√© les erreurs de compilation,
le plugin Maven Compiler **s'attendait** √† avoir des propri√©t√© d√©finies comme d√©fini dans la documentation.
* On peut √©galement "configurer" tr√®s finement Maven √† l'aide des balises XML du `pom.xml`

== Exercice : Changer le nom de l'artefact final

* *But*: Produire un artefact JAR dont le nom est constant

* Toujours dans link:https://gitpod.io#https://github.com/cicd-lectures/demoapp[l'environnement GitPod,window="_blank"],
ex√©cutez la commande `mvn package`

* Quel est le nom de l'artefact g√©n√©r√© ? Est-il constant ?
** (SPOILER: üôÖüèΩ‚Äç‚ôÄÔ∏è)

* En utilisant la documentation de r√©f√©rence link:https://maven.apache.org/pom.html#the-basebuild-element-set[],
adaptez votre `pom.xml` afin que le fichier g√©n√©r√© se nomme *toujours*  `hello.jar`.

== Solution : Changer le nom de l'artefact final

[source,xml]
----
<build>
  <finalName>hello</finalName>
</build>
----

== Maven Plugins

Un plugin Maven impl√©mente les t√¢ches √† effectuer durant les diff√©rentes phases,
et peut appartenir √† l'un ou √† tous ces types :

* *"Build"* : Impl√©mente une action durant les phase de "build" (clean, compile, test, etc.),
et est configur√© dans la balise `<build>`
* *"Reporting"* Impl√©mente une action durant la phase de g√©n√©ration de "site",
et est configur√© dans la balise `<reporting>` (√† votre grande surprise)

== Exercice : Maven JAR Plugin

* *But*: Produire l'artefact JAR dans un dossier nomm√© `dist` √† c√¥t√© du `pom.xml` et de `target/`

* La g√©n√©ration du JAR est d√©clench√©e lors de l'appel √† `mvn package`, il nous faut une documentation !
** Est-ce qu'il y a un plugin `package` dans la https://maven.apache.org/plugins/[page de la liste des plugins Maven] ?
** A vous de chercher pour trouver la documentation du plugin et d'y trouver le bon r√©glage permettant
de changer le dossier d'"output"

== Solution : Maven JAR Plugin

* https://maven.apache.org/plugins/
** https://maven.apache.org/plugins/maven-jar-plugin/
*** https://maven.apache.org/plugins/maven-jar-plugin/jar-mojo.html

[source,xml]
----
<build>
  <!-- ... -->
  <plugins>
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-jar-plugin</artifactId>
      <executions>
        <execution>
          <configuration>
            <outputDirectory>./dist/</outputDirectory>
          </configuration>
        </execution>
      </executions>
    </plugin>
  </plugins>
</build>
----

// == Exercice : Couverture de code avec Jacoco

// * *But* : G√©n√©rer un/des rapport(s) de couverture de code

// * Reprenez la branche `full-maven` de `demoapp`, qui contient des tests unitaires et d'int√©gration
// * En utilisant https://www.eclemma.org/jacoco/trunk/doc/maven.html[la documentation du plugin Jacoco],
// assurez-vous de g√©n√©rer un rapport au format HTML d'un des types de test de votre choix
